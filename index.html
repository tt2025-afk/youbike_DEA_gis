<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouBike 營運決策支援系統 - 大安區專用</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f3f4f6; }
        
        #header { height: 60px; z-index: 50; }
        #dashboard { height: 100px; z-index: 40; }
        #main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #map-container { flex: 3; min-height: 400px; position: relative; }
        #table-container { flex: 2; overflow-y: auto; background: white; border-top: 4px solid #e5e7eb; padding: 10px; }
        #map { height: 100%; width: 100%; }

        /* 自訂標記樣式 */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 34px; height: 34px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -17px 0 0 -17px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .marker-pin::after {
            content: ''; width: 26px; height: 26px; margin: 4px 0 0 4px;
            background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-icon {
            position: absolute; width: 22px; font-size: 16px;
            left: 0; right: 0; margin: 9px auto; text-align: center;
            z-index: 10; font-weight: bold;
        }

        /* 顏色定義 (對應 Python 輸出的決策) */
        .bg-action-expand { background-color: #10b981; } /* 綠: 擴張 */
        .bg-action-reduce { background-color: #ef4444; } /* 紅: 縮減 */
        .bg-action-relocate { background-color: #f97316; } /* 橘: 整併/撤站 */
        .bg-action-maintain { background-color: #3b82f6; } /* 藍: 維持 */
        
        /* 表格樣式微調 */
        table.dataTable thead th { background-color: #f8fafc; font-size: 0.85rem; color: #475569; }
        table.dataTable tbody td { font-size: 0.85rem; padding: 8px 10px; }
    </style>
</head>
<body>

    <!-- 1. 頂部導航列 -->
    <div id="header" class="bg-slate-800 text-white flex items-center justify-between px-6 shadow-lg">
        <div class="flex items-center space-x-3">
            <div class="bg-yellow-500 p-2 rounded-lg text-slate-900"><i class="fas fa-chart-line text-lg"></i></div>
            <div>
                <h1 class="text-lg font-bold tracking-wide">YouBike 營運決策支援系統</h1>
                <p class="text-xs text-slate-400">大安區站點資源配置優化 (DEA Model M=2, S=3)</p>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="bg-slate-700 px-3 py-1.5 rounded border border-slate-600 flex items-center">
                <label class="text-xs text-slate-300 mr-2"><i class="fas fa-file-csv mr-1"></i>匯入 Python 結果檔:</label>
                <input type="file" id="csvInput" accept=".csv" class="text-xs text-slate-300 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-xs file:bg-blue-600 file:text-white hover:file:bg-blue-500 cursor-pointer"/>
            </div>
        </div>
    </div>

    <!-- 2. 決策儀表板 (KPIs) -->
    <div id="dashboard" class="bg-white border-b border-gray-200 px-6 py-3 grid grid-cols-5 gap-4 items-center shadow-sm">
        
        <!-- 卡片 1: 總站點 -->
        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 flex flex-col justify-center items-center cursor-pointer hover:bg-gray-100 transition" onclick="filterMap('all')">
            <span class="text-xs text-gray-500 font-bold uppercase">總分析站點</span>
            <span class="text-2xl font-black text-gray-700" id="stat-total">-</span>
        </div>

        <!-- 卡片 2: 建議擴張 -->
        <div class="bg-green-50 rounded-lg p-3 border border-green-200 flex flex-col justify-center items-center cursor-pointer hover:bg-green-100 transition group" onclick="filterMap('expand')">
            <span class="text-xs text-green-700 font-bold uppercase flex items-center"><i class="fas fa-expand-arrows-alt mr-1"></i> 優先擴張</span>
            <span class="text-2xl font-black text-green-600 group-hover:scale-110 transition" id="stat-expand">-</span>
        </div>

        <!-- 卡片 3: 建議縮減 -->
        <div class="bg-red-50 rounded-lg p-3 border border-red-200 flex flex-col justify-center items-center cursor-pointer hover:bg-red-100 transition group" onclick="filterMap('reduce')">
            <span class="text-xs text-red-700 font-bold uppercase flex items-center"><i class="fas fa-compress-arrows-alt mr-1"></i> 縮減規模</span>
            <span class="text-2xl font-black text-red-600 group-hover:scale-110 transition" id="stat-reduce">-</span>
        </div>

        <!-- 卡片 4: 建議遷移 -->
        <div class="bg-orange-50 rounded-lg p-3 border border-orange-200 flex flex-col justify-center items-center cursor-pointer hover:bg-orange-100 transition group" onclick="filterMap('relocate')">
            <span class="text-xs text-orange-700 font-bold uppercase flex items-center"><i class="fas fa-map-marked-alt mr-1"></i> 整併/撤站</span>
            <span class="text-2xl font-black text-orange-600 group-hover:scale-110 transition" id="stat-relocate">-</span>
        </div>

        <!-- 卡片 5: 嚴重缺車 (調度) -->
        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200 flex flex-col justify-center items-center cursor-pointer hover:bg-yellow-100 transition group" onclick="filterMap('shortage')">
            <span class="text-xs text-yellow-700 font-bold uppercase flex items-center"><i class="fas fa-truck-loading mr-1"></i> 嚴重缺車</span>
            <span class="text-2xl font-black text-yellow-600 group-hover:scale-110 transition" id="stat-shortage">-</span>
        </div>
    </div>

    <!-- 3. 主內容區 -->
    <div id="main-container">
        
        <!-- 地圖區 -->
        <div id="map-container">
            <div id="map"></div>
            
            <!-- 地圖圖例 -->
            <div class="absolute bottom-6 right-6 bg-white p-3 rounded-lg shadow-lg z-[400] text-xs opacity-90">
                <h4 class="font-bold mb-2 border-b pb-1">決策燈號說明</h4>
                <div class="flex items-center mb-1"><span class="w-3 h-3 rounded-full bg-action-expand mr-2"></span> 優先擴張 (高效+缺車)</div>
                <div class="flex items-center mb-1"><span class="w-3 h-3 rounded-full bg-action-reduce mr-2"></span> 縮減規模 (嚴重過剩)</div>
                <div class="flex items-center mb-1"><span class="w-3 h-3 rounded-full bg-action-relocate mr-2"></span> 整併/撤站 (效率極低)</div>
                <div class="flex items-center mb-1"><span class="w-3 h-3 rounded-full bg-action-maintain mr-2"></span> 維持/觀察</div>
                <hr class="my-2">
                <div class="flex items-center mb-1"><i class="fas fa-arrow-up text-red-500 mr-2"></i> 淨輸出 (缺車)</div>
                <div class="flex items-center"><i class="fas fa-arrow-down text-green-500 mr-2"></i> 淨吸納 (滿位)</div>
            </div>
        </div>

        <!-- 資料列表區 -->
        <div id="table-container">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-700"><i class="fas fa-list-ul mr-2"></i>站點決策清單</h3>
                <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">點擊表頭可排序，使用右側搜尋框查找特定站點</span>
            </div>
            <table id="dataTable" class="display w-full border-collapse" style="width:100%">
                <thead>
                    <tr>
                        <th class="text-left">站點名稱 (DMU)</th>
                        <th>效率值 (E)</th>
                        <th>車位過剩 (Slack)</th>
                        <th>人口過剩 (Pop)</th>
                        <th>淨流量 (NetFlow)</th>
                        <th>資源建議</th>
                        <th>空間決策 (行動)</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS 動態填入 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        let map;
        let allMarkers = [];
        let dataTable;

        // 初始化
        $(document).ready(function() {
            initMap();
            initTable();
            loadDemoData(); // 載入您真實數據的前幾筆作為範例
        });

        function initMap() {
            map = L.map('map', { center: [25.0330, 121.5430], zoom: 14 });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19
            }).addTo(map);
        }

        function initTable() {
            dataTable = $('#dataTable').DataTable({
                paging: false,
                scrollY: '300px',
                scrollCollapse: true,
                info: false,
                searching: true,
                order: [[ 6, 'desc' ]], // 預設依空間決策排序
                language: { search: "搜尋站點:", zeroRecords: "沒有符合的資料" }
            });
        }

        // 解析 CSV (包含 BOM 處理與空欄位過濾)
        function parseCSV(text) {
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            const lines = text.split('\n').filter(l => l.trim()); // 過濾空行
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const data = lines.slice(1).map(line => {
                const row = line.split(',');
                // 允許 CSV 尾端有空欄位，只要前幾個關鍵欄位有值即可
                if(row.length < 5) return null; 
                let obj = {};
                headers.forEach((h, i) => {
                    if (h) { // 忽略無名標題
                        obj[h] = row[i] ? row[i].trim().replace(/^"|"$/g, '') : '';
                    }
                });
                return obj;
            }).filter(item => item !== null);
            
            return data;
        }

        function renderSystem(data) {
            // 清除舊資料
            allMarkers.forEach(m => map.removeLayer(m));
            allMarkers = [];
            dataTable.clear();

            let stats = { total: 0, expand: 0, reduce: 0, relocate: 0, shortage: 0 };

            data.forEach((row) => {
                // 1. 欄位對應 (依據您提供的 dea_results_for_gis.csv)
                const lat = parseFloat(row.Latitude);
                const lng = parseFloat(row.Longitude);
                if (isNaN(lat) || isNaN(lng)) return;

                const name = row.DMU;
                const e = parseFloat(row.DEA_E_Score || 0).toFixed(3);
                const slackDocks = parseFloat(row.Slack_Docks || 0).toFixed(1);
                const slackPop = parseFloat(row.Slack_Pop || 0).toFixed(0);
                const nf = parseInt(row.NetFlow || 0);
                
                // 決策字串判斷 (對應 Python 輸出)
                const decision = row['空間決策'] || "【維持現狀】";
                const resourceAdvice = row['資源建議'] || "";

                // 2. 統計
                stats.total++;
                if(decision.includes("擴張")) stats.expand++;
                if(decision.includes("縮減")) stats.reduce++;
                if(decision.includes("整併") || decision.includes("撤站")) stats.relocate++;
                if(nf > 400) stats.shortage++; // 嚴重缺車門檻

                // 3. 決定樣式
                let color = "#3b82f6"; // 藍 (維持)
                let iconClass = "fa-bicycle";
                
                if (decision.includes("擴張")) { color = "#10b981"; iconClass = "fa-expand-alt"; } // 綠
                else if (decision.includes("縮減")) { color = "#ef4444"; iconClass = "fa-compress-alt"; } // 紅
                else if (decision.includes("整併") || decision.includes("撤站")) { color = "#f97316"; iconClass = "fa-map-marked-alt"; } // 橘
                
                // 決定箭頭方向 (淨流量)
                let flowIcon = "";
                if (nf > 400) flowIcon = "fa-arrow-up";   // 缺車 (紅箭頭)
                else if (nf < -300) flowIcon = "fa-arrow-down"; // 滿位 (綠箭頭)

                // 4. 建立地圖 Marker
                const iconHtml = `
                    <div style="background-color: ${color}" class="marker-pin"></div>
                    <i class="fas ${flowIcon || iconClass} marker-icon" 
                       style="color: ${nf > 400 ? '#dc2626' : (nf < -300 ? '#16a34a' : '#fff')}"></i>
                `;
                
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [34, 42], iconAnchor: [17, 42], popupAnchor: [0, -40] })
                });

                // Popup 內容
                const popupHtml = `
                    <div class="p-1 min-w-[220px]">
                        <h4 class="font-bold text-gray-800 border-b pb-1 mb-2">${name}</h4>
                        <div class="text-sm space-y-1">
                            <div><span class="text-gray-500">決策建議:</span> <span class="font-bold" style="color:${color}">${decision}</span></div>
                            <div><span class="text-gray-500">效率值 (E):</span> ${e}</div>
                            <div><span class="text-gray-500">車位過剩:</span> <span class="${slackDocks > 5 ? 'text-red-500 font-bold' : ''}">${slackDocks > 0 ? slackDocks + ' 柱' : '-'}</span></div>
                            <div><span class="text-gray-500">淨流量:</span> <span class="${nf > 0 ? 'text-red-500' : 'text-green-500'} font-bold">${nf > 0 ? '+' + nf : nf}</span></div>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupHtml);
                marker.data = { decision: decision, nf: nf };
                marker.addTo(map);
                allMarkers.push(marker);

                // 5. 建立表格 Row
                const locateBtn = `<button onclick="focusMarker(${lat}, ${lng}, '${name}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded text-xs transition"><i class="fas fa-search-location"></i></button>`;
                const decisionTag = `<span class="px-2 py-1 rounded text-xs font-bold text-white" style="background-color: ${color}">${decision}</span>`;

                dataTable.row.add([
                    name,
                    e,
                    slackDocks > 5 ? `<span class="text-red-600 font-bold">${slackDocks}</span>` : slackDocks,
                    slackPop > 1000 ? `<span class="text-orange-500">${slackPop}</span>` : '-',
                    nf > 0 ? `+${nf}` : nf,
                    resourceAdvice,
                    decisionTag,
                    locateBtn
                ]);
            });

            // 更新儀表板
            $('#stat-total').text(stats.total);
            $('#stat-expand').text(stats.expand);
            $('#stat-reduce').text(stats.reduce);
            $('#stat-relocate').text(stats.relocate);
            $('#stat-shortage').text(stats.shortage);

            dataTable.draw();
        }

        function filterMap(type) {
            allMarkers.forEach(m => {
                const d = m.data.decision;
                const nf = m.data.nf;
                let show = false;

                if (type === 'all') show = true;
                else if (type === 'expand' && d.includes("擴張")) show = true;
                else if (type === 'reduce' && d.includes("縮減")) show = true;
                else if (type === 'relocate' && (d.includes("整併") || d.includes("撤站"))) show = true;
                else if (type === 'shortage' && nf > 400) show = true;

                if (show) map.addLayer(m);
                else map.removeLayer(m);
            });
            
            const searchKey = type === 'all' ? '' : type === 'expand' ? '擴張' : type === 'reduce' ? '縮減' : type === 'relocate' ? '整併' : '';
            if(type !== 'shortage') dataTable.search(searchKey).draw();
        }

        window.focusMarker = function(lat, lng, name) {
            map.flyTo([lat, lng], 16, { duration: 1.5 });
            const marker = allMarkers.find(m => m.getLatLng().lat === lat && m.getLatLng().lng === lng);
            if(marker) setTimeout(() => marker.openPopup(), 1500);
        };

        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = parseCSV(e.target.result);
                    if(data.length > 0) renderSystem(data);
                } catch(err) { alert("讀取錯誤: " + err); }
            };
            reader.readAsText(file);
        });

        // 預載 Demo 資料 (依據您真實數據範例)
        function loadDemoData() {
            const demo = [
                { DMU: "捷運公館站(2號出口)", Latitude: 25.01491, Longitude: 121.53438, DEA_E_Score: 1, Slack_Docks: 0, NetFlow: -3085, 空間決策: "【維持現狀】", 資源建議: "配置合理" },
                { DMU: "捷運六張犁站", Latitude: 25.02397, Longitude: 121.55266, DEA_E_Score: 0.616, Slack_Docks: 24.6, NetFlow: 1142, 空間決策: "【縮減規模】", 資源建議: "嚴重過剩" },
                { DMU: "捷運麟光站(2號出口)", Latitude: 25.0181, Longitude: 121.55929, DEA_E_Score: 0.379, Slack_Docks: 31.1, NetFlow: -189, 空間決策: "【整併/撤站評估】", 資源建議: "嚴重過剩" },
                { DMU: "捷運忠孝新生站(4號出口)", Latitude: 25.04239, Longitude: 121.53324, DEA_E_Score: 0.508, Slack_Docks: 22.6, NetFlow: 724, 空間決策: "【縮減規模】", 資源建議: "嚴重過剩" },
                { DMU: "捷運信義安和站(4號出口)", Latitude: 25.03323, Longitude: 121.55248, DEA_E_Score: 0.524, Slack_Docks: 20.5, NetFlow: 868, 空間決策: "【縮減規模】", 資源建議: "嚴重過剩" }
            ];
            renderSystem(demo);
        }
    </script>
</body>
</html>



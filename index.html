<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouBike 營運決策中控台</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; background-color: #f8fafc; font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; }
        
        /* 佈局 */
        #header { height: 70px; z-index: 50; }
        #main-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #map-container { flex: 5; position: relative; min-height: 400px; }
        #list-container { flex: 4; background: white; display: flex; flex-direction: column; border-top: 4px solid #94a3b8; }
        #map { height: 100%; width: 100%; }

        /* 自訂標記樣式 */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 36px; height: 36px; border-radius: 50% 50% 50% 0;
            position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -18px 0 0 -18px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }
        .marker-pin::after {
            content: ''; width: 24px; height: 24px; margin: 4px 0 0 4px;
            background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-icon {
            position: absolute; width: 22px; font-size: 16px;
            left: 0; right: 0; margin: 10px auto; text-align: center;
            z-index: 10; font-weight: bold;
        }

        /* 顏色定義 */
        .bg-benchmark { background-color: #facc15; } /* 黃 */
        .bg-high { background-color: #22c55e; }      /* 綠 */
        .bg-mid { background-color: #3b82f6; }       /* 藍 */
        .bg-low { background-color: #ef4444; }       /* 紅 */

        /* 列表樣式 */
        .station-row:hover { background-color: #f0f9ff; cursor: pointer; border-left: 4px solid #0ea5e9; }
        .station-row.active { background-color: #e0f2fe; border-left: 4px solid #0284c7; font-weight: bold; }
        
        /* 按鈕樣式 */
        .mode-btn { opacity: 0.6; transition: all 0.2s; border: 1px solid transparent; }
        .mode-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.3); border-color: white; }
        
        .sub-btn { background: white; color: #475569; border: 1px solid #cbd5e1; display: flex; align-items: center; }
        .sub-btn:hover { background-color: #f1f5f9; }
        .sub-btn.active { background: #0f172a; color: white; border-color: #0f172a; }
        .count-badge {
            background-color: rgba(0,0,0,0.1); 
            padding: 1px 6px; 
            border-radius: 10px; 
            font-size: 0.7rem; 
            margin-left: 6px;
        }
        .sub-btn.active .count-badge { background-color: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <!-- 1. 頂部導航列 -->
    <div id="header" class="bg-slate-900 text-white flex items-center justify-between px-4 shadow-lg">
        <div class="flex items-center space-x-3">
            <div class="bg-yellow-500 p-1.5 rounded text-slate-900"><i class="fas fa-bicycle text-xl"></i></div>
            <div>
                <h1 class="text-lg font-bold tracking-wide leading-tight">YouBike 營運決策中控台</h1>
                <p class="text-xs text-slate-400">大安區站點資源配置優化</p>
            </div>
        </div>
        
        <!-- 右側控制區 -->
        <div class="flex items-center space-x-4">
            <!-- 模式切換 -->
            <div class="flex bg-slate-800 rounded p-1 space-x-1">
                <button onclick="setMode('efficiency')" id="btn-efficiency" class="mode-btn px-3 py-1.5 rounded bg-amber-500 text-white text-xs font-bold flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i> 效率分析
                </button>
                <button onclick="setMode('resource')" id="btn-resource" class="mode-btn active px-3 py-1.5 rounded bg-blue-600 text-white text-xs font-bold flex items-center">
                    <i class="fas fa-cubes mr-2"></i> 資源規模
                </button>
                <button onclick="setMode('dispatch')" id="btn-dispatch" class="mode-btn px-3 py-1.5 rounded bg-purple-600 text-white text-xs font-bold flex items-center">
                    <i class="fas fa-truck-moving mr-2"></i> 營運調度
                </button>
            </div>

            <!-- CSV 上傳 -->
            <div class="flex items-center">
                <label class="cursor-pointer text-slate-200 text-xs flex items-center hover:text-white transition bg-slate-600 px-3 py-1.5 rounded border border-slate-500">
                    <i class="fas fa-upload mr-1"></i> 匯入檔案
                    <input type="file" id="csvInput" accept=".csv,.txt" class="hidden" />
                </label>
            </div>
        </div>
    </div>

    <div id="main-container">
        
        <!-- 地圖區 -->
        <div id="map-container">
            <div id="map"></div>
            
            <!-- 浮動控制面板 -->
            <div class="absolute top-4 right-4 z-[400] flex flex-col items-end space-y-3 pointer-events-none">
                
                <!-- 1. 效率分析子篩選 -->
                <div id="efficiency-filters" class="bg-white/95 backdrop-blur shadow-xl rounded-lg p-2 pointer-events-auto border border-slate-200 hidden">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 px-1">效率等級篩選：</div>
                    <div class="flex space-x-1">
                        <button onclick="setSubFilter('eff_all')" id="sub-eff-all" class="sub-btn active px-2 py-1 rounded text-xs font-bold transition">
                            全部 <span id="count-eff-all" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('eff_benchmark')" id="sub-eff-benchmark" class="sub-btn px-2 py-1 rounded text-xs font-bold transition hover:bg-yellow-50 hover:text-yellow-700">
                            <span class="w-2 h-2 rounded-full bg-benchmark mr-1"></span> 標竿 <span id="count-eff-benchmark" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('eff_high')" id="sub-eff-high" class="sub-btn px-2 py-1 rounded text-xs font-bold transition hover:bg-green-50 hover:text-green-700">
                            <span class="w-2 h-2 rounded-full bg-high mr-1"></span> 高效 <span id="count-eff-high" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('eff_mid')" id="sub-eff-mid" class="sub-btn px-2 py-1 rounded text-xs font-bold transition hover:bg-blue-50 hover:text-blue-700">
                            <span class="w-2 h-2 rounded-full bg-mid mr-1"></span> 中效 <span id="count-eff-mid" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('eff_low')" id="sub-eff-low" class="sub-btn px-2 py-1 rounded text-xs font-bold transition hover:bg-red-50 hover:text-red-700">
                            <span class="w-2 h-2 rounded-full bg-low mr-1"></span> 低效 <span id="count-eff-low" class="count-badge">0</span>
                        </button>
                    </div>
                </div>

                <!-- 2. 資源規模子篩選 -->
                <div id="resource-filters" class="bg-white/95 backdrop-blur shadow-xl rounded-lg p-2 pointer-events-auto border border-slate-200">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 px-1">規模關注點：</div>
                    <div class="flex space-x-1">
                        <button onclick="setSubFilter('all_resource')" id="sub-all-resource" class="sub-btn active px-2 py-1 rounded text-xs font-bold transition">
                            全部 <span id="count-all-resource" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('reduce')" id="sub-reduce" class="sub-btn px-2 py-1 rounded text-xs font-bold transition text-red-600">
                            <i class="fas fa-compress-alt mr-1"></i> 縮減 <span id="count-reduce" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('observe')" id="sub-observe" class="sub-btn px-2 py-1 rounded text-xs font-bold transition text-yellow-600">
                            <i class="fas fa-eye mr-1"></i> 觀察 <span id="count-observe" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('maintain')" id="sub-maintain" class="sub-btn px-2 py-1 rounded text-xs font-bold transition text-blue-600">
                            <i class="fas fa-check mr-1"></i> 維持 <span id="count-maintain" class="count-badge">0</span>
                        </button>
                    </div>
                </div>

                <!-- 3. 調度子篩選 -->
                <div id="dispatch-filters" class="bg-white/95 backdrop-blur shadow-xl rounded-lg p-2 pointer-events-auto hidden border border-slate-200">
                    <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 px-1">調度關注點：</div>
                    <div class="flex space-x-1">
                        <button onclick="setSubFilter('supply')" id="sub-supply" class="sub-btn active px-2 py-1 rounded text-xs font-bold transition text-red-600">
                            <i class="fas fa-arrow-up mr-1"></i> 頻繁補給 <span id="count-supply" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('clear')" id="sub-clear" class="sub-btn px-2 py-1 rounded text-xs font-bold transition text-green-600">
                            <i class="fas fa-arrow-down mr-1"></i> 加強清運 <span id="count-clear" class="count-badge">0</span>
                        </button>
                        <button onclick="setSubFilter('balance')" id="sub-balance" class="sub-btn px-2 py-1 rounded text-xs font-bold transition text-blue-600">
                            <i class="fas fa-balance-scale mr-1"></i> 流量平衡 <span id="count-balance" class="count-badge">0</span>
                        </button>
                    </div>
                </div>

                <!-- 顏色圖例 -->
                <div class="bg-white/95 backdrop-blur shadow-xl rounded-lg p-3 pointer-events-auto border border-slate-200 w-32">
                    <h4 class="text-xs font-bold text-slate-500 mb-2 border-b pb-1">效率等級</h4>
                    <div class="space-y-1.5 text-xs font-medium text-slate-700">
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-benchmark mr-2 shadow-sm border border-black/10"></span> 標竿 (黃)</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-high mr-2 shadow-sm border border-black/10"></span> 高效 (綠)</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-mid mr-2 shadow-sm border border-black/10"></span> 中效 (藍)</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-low mr-2 shadow-sm border border-black/10"></span> 低效 (紅)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列表區 -->
        <div id="list-container">
            <div class="px-4 py-2 border-b bg-gray-50 flex justify-between items-center shadow-sm z-10 h-10">
                <div class="flex items-center">
                    <h3 class="font-bold text-slate-800 mr-3 text-sm" id="list-title">資源分配建議列表</h3>
                    <span class="bg-slate-200 text-slate-600 text-xs px-2 py-0.5 rounded-full font-bold" id="list-count">0</span>
                </div>
                <div class="text-xs text-slate-500 font-medium bg-yellow-50 px-2 py-1 rounded border border-yellow-200 text-yellow-700">
                    <i class="fas fa-sort-amount-down-alt mr-1"></i> <span id="sort-desc">依效率值 (低→高) 排序</span>
                </div>
            </div>

            <div class="flex-grow overflow-auto relative">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white sticky top-0 z-10 text-[11px] text-slate-500 uppercase tracking-wider font-bold border-b">
                        <tr>
                            <th class="px-4 py-2 w-10 text-center">燈號</th>
                            <th class="px-4 py-2">站點名稱</th>
                            <th class="px-4 py-2 w-20 text-center">效率值</th>
                            <th class="px-4 py-2 w-24 text-center">建議減少車輛<br>(Slack)</th>
                            <th class="px-4 py-2 w-24 text-center">淨流量</th>
                            <th class="px-4 py-2 w-1/3" id="col-action">建議行動</th>
                            <th class="px-4 py-2 w-16 text-right">定位</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm text-slate-700">
                        <!-- JS 填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let allData = [];
        let markers = [];
        let currentMode = 'resource';
        let currentSubFilter = 'all_resource'; 

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadDemoData(); // 預載範例
            document.getElementById('csvInput').addEventListener('change', handleFileUpload);
        });

        function initMap() {
            map = L.map('map', { center: [25.0330, 121.5430], zoom: 14 });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // --- 模式切換 ---
        window.setMode = function(mode) {
            currentMode = mode;
            
            // 按鈕樣式
            document.getElementById('btn-efficiency').classList.toggle('active', mode === 'efficiency');
            document.getElementById('btn-resource').classList.toggle('active', mode === 'resource');
            document.getElementById('btn-dispatch').classList.toggle('active', mode === 'dispatch');
            
            // 面板控制
            const effFilters = document.getElementById('efficiency-filters');
            const resourceFilters = document.getElementById('resource-filters');
            const dispatchFilters = document.getElementById('dispatch-filters');
            
            const listTitle = document.getElementById('list-title');
            const sortDesc = document.getElementById('sort-desc');
            const colAction = document.getElementById('col-action');

            // 重置顯示
            effFilters.classList.add('hidden');
            resourceFilters.classList.add('hidden');
            dispatchFilters.classList.add('hidden');

            if (mode === 'efficiency') {
                effFilters.classList.remove('hidden');
                listTitle.innerText = '站點效率分析列表';
                colAction.innerText = '效率等級說明';
                setSubFilter('eff_all'); 
            } else if (mode === 'dispatch') {
                dispatchFilters.classList.remove('hidden');
                listTitle.innerText = '營運調度建議列表';
                colAction.innerText = '調度策略';
                setSubFilter('supply'); 
            } else {
                resourceFilters.classList.remove('hidden');
                listTitle.innerText = '資源分配與規模調整列表';
                colAction.innerText = '規模建議';
                setSubFilter('all_resource'); 
            }
        }

        window.setSubFilter = function(filter) {
            currentSubFilter = filter;
            
            // 重置所有子按鈕樣式
            document.querySelectorAll('.sub-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 設定當前按鈕樣式 (ID 對應 map)
            const btnMap = {
                'all_resource': 'sub-all-resource',
                'reduce': 'sub-reduce',
                'observe': 'sub-observe', 
                'maintain': 'sub-maintain',
                'supply': 'sub-supply',
                'clear': 'sub-clear',
                'balance': 'sub-balance',
                'eff_all': 'sub-eff-all',
                'eff_benchmark': 'sub-eff-benchmark',
                'eff_high': 'sub-eff-high',
                'eff_mid': 'sub-eff-mid',
                'eff_low': 'sub-eff-low'
            };
            
            if(btnMap[filter]) {
                document.getElementById(btnMap[filter]).classList.add('active');
            }

            // 更新排序描述
            const sortDesc = document.getElementById('sort-desc');
            if (currentMode === 'efficiency') {
                sortDesc.innerText = '排序：效率值 (高 → 低)';
            } else if (currentMode === 'resource') {
                 sortDesc.innerText = '排序：效率值 (低 → 高)';
            } else {
                if (filter === 'supply') sortDesc.innerText = '排序：淨輸出 (缺車嚴重者優先)';
                else if (filter === 'clear') sortDesc.innerText = '排序：淨吸納 (滿位嚴重者優先)';
                else sortDesc.innerText = '排序：淨流量接近 0 優先';
            }
            
            renderView();
        }

        // --- 檔案處理 ---
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsText(file, 'Big5'); 
            
            reader.onload = (e) => {
                let text = e.target.result;
                let data = parseCSV(text);
                
                if (data.length === 0 || !JSON.stringify(data[0]).includes('效率')) {
                     const readerUTF8 = new FileReader();
                     readerUTF8.readAsText(file, 'UTF-8');
                     readerUTF8.onload = (e2) => {
                         const textUTF8 = e2.target.result;
                         const dataUTF8 = parseCSV(textUTF8);
                         if (dataUTF8.length > 0) {
                             allData = dataUTF8;
                             updateCounts(); 
                             renderView();
                             const group = new L.featureGroup(markers);
                             if(markers.length > 0) map.fitBounds(group.getBounds().pad(0.1));
                         } else {
                             alert('讀取失敗，請確認檔案格式');
                         }
                     }
                } else {
                    allData = data;
                    updateCounts();
                    renderView();
                    const group = new L.featureGroup(markers);
                    if(markers.length > 0) map.fitBounds(group.getBounds().pad(0.1));
                }
            };
        }

        function parseCSV(text) {
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
            const lines = text.split('\n').filter(l => l.trim());
            const delimiter = text.indexOf('\t') !== -1 ? '\t' : ',';
            const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));
            
            return lines.slice(1).map(line => {
                const row = line.split(delimiter);
                if (row.length < 2) return null;
                let obj = {};
                headers.forEach((h, i) => {
                    if(h) obj[h] = row[i] ? row[i].trim().replace(/^"|"$/g, '') : '';
                });
                return obj;
            }).filter(item => item !== null);
        }

        // --- 核心邏輯 ---
        
        function updateCounts() {
            // 資源
            const cntReduce = allData.filter(i => (i['資源分配與規模調整'] || "").includes('【縮減規模')).length;
            const cntObserve = allData.filter(i => (i['資源分配與規模調整'] || "").includes('【列入觀察】')).length;
            const cntMaintain = allData.filter(i => (i['資源分配與規模調整'] || "").includes('【維持現狀】')).length;
            
            document.getElementById('count-all-resource').innerText = allData.length;
            document.getElementById('count-reduce').innerText = cntReduce;
            document.getElementById('count-observe').innerText = cntObserve;
            document.getElementById('count-maintain').innerText = cntMaintain;

            // 調度
            const cntSupply = allData.filter(i => (i['營運調度'] || "").includes('【頻繁補給')).length;
            const cntClear = allData.filter(i => (i['營運調度'] || "").includes('【加強清運】')).length;
            const cntBalance = allData.filter(i => (i['營運調度'] || "").includes('【流量平衡】')).length;

            document.getElementById('count-supply').innerText = cntSupply;
            document.getElementById('count-clear').innerText = cntClear;
            document.getElementById('count-balance').innerText = cntBalance;

            // 效率 (依據等級字串)
            const cntEffAll = allData.length;
            const cntEffBench = allData.filter(i => (i['效率等級'] || "").includes('標竿')).length;
            const cntEffHigh = allData.filter(i => (i['效率等級'] || "").includes('高效')).length;
            const cntEffMid = allData.filter(i => (i['效率等級'] || "").includes('中效')).length;
            const cntEffLow = allData.filter(i => (i['效率等級'] || "").includes('低效')).length;

            document.getElementById('count-eff-all').innerText = cntEffAll;
            document.getElementById('count-eff-benchmark').innerText = cntEffBench;
            document.getElementById('count-eff-high').innerText = cntEffHigh;
            document.getElementById('count-eff-mid').innerText = cntEffMid;
            document.getElementById('count-eff-low').innerText = cntEffLow;
        }

        function renderView() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            let displayData = [];

            // 1. 篩選
            displayData = allData.filter(item => {
                const resourceKey = Object.keys(item).find(k => k.includes('資源') || k.includes('規模'));
                const dispatchKey = Object.keys(item).find(k => k.includes('調度') || k.includes('流量'));
                const levelKey = Object.keys(item).find(k => k.includes('效率等級'));
                
                const resourceAdvice = item[resourceKey] || "";
                const dispatchAdvice = item[dispatchKey] || "";
                const level = item[levelKey] || "";
                const nf = parseInt(item.NetFlow || item.NF || item['淨流量'] || 0);

                if (currentMode === 'resource') {
                    if (currentSubFilter === 'all_resource') return true;
                    if (currentSubFilter === 'reduce') return resourceAdvice.includes('【縮減規模');
                    if (currentSubFilter === 'observe') return resourceAdvice.includes('【列入觀察】');
                    if (currentSubFilter === 'maintain') return resourceAdvice.includes('【維持現狀】');
                } else if (currentMode === 'dispatch') {
                    if (currentSubFilter === 'supply') return dispatchAdvice.includes('【頻繁補給');
                    if (currentSubFilter === 'clear') return dispatchAdvice.includes('【加強清運】');
                    if (currentSubFilter === 'balance') return dispatchAdvice.includes('【流量平衡】');
                } else if (currentMode === 'efficiency') {
                    if (currentSubFilter === 'eff_all') return true;
                    if (currentSubFilter === 'eff_benchmark') return level.includes('標竿');
                    if (currentSubFilter === 'eff_high') return level.includes('高效');
                    if (currentSubFilter === 'eff_mid') return level.includes('中效');
                    if (currentSubFilter === 'eff_low') return level.includes('低效');
                }
                return false;
            });

            // 2. 排序
            displayData.sort((a, b) => {
                const eA = parseFloat(a.DEA_E_Score || a['效率值'] || 0);
                const eB = parseFloat(b.DEA_E_Score || b['效率值'] || 0);
                const nfA = parseInt(a.NetFlow || a['淨流量'] || 0);
                const nfB = parseInt(b.NetFlow || b['淨流量'] || 0);

                if (currentMode === 'efficiency') {
                    return eB - eA; // 效率高優先
                } else if (currentMode === 'resource') {
                    return eA - eB; // 效率低優先
                } else {
                    if (currentSubFilter === 'supply') return nfB - nfA; // 淨輸出大優先
                    else if (currentSubFilter === 'clear') return nfA - nfB; // 淨吸納大優先
                    else return Math.abs(nfA) - Math.abs(nfB); // 接近0優先
                }
            });

            document.getElementById('list-count').innerText = `${displayData.length} 站`;

            // 3. 渲染
            displayData.forEach(item => {
                const lat = parseFloat(item.Latitude || item.Lat);
                const lng = parseFloat(item.Longitude || item.Lng);
                const name = item.DMU || item.DMU_Name || item['站點名稱'];
                const e = parseFloat(item.DEA_E_Score || item.E || item['效率值'] || 0);
                const netFlow = parseInt(item.NetFlow || item.NF || item['淨流量'] || 0);
                const slackDocks = parseFloat(item.Slack_Docks || item.Slack_X1 || item['車位過剩'] || 0);
                const levelKey = Object.keys(item).find(k => k.includes('效率等級'));
                const level = item[levelKey] || "";
                
                let actionText = '';
                if (currentMode === 'resource') {
                    const key = Object.keys(item).find(k => k.includes('資源') || k.includes('規模'));
                    actionText = item[key] || "-";
                } else if (currentMode === 'dispatch') {
                    const key = Object.keys(item).find(k => k.includes('調度') || k.includes('流量'));
                    actionText = item[key] || "-";
                } else {
                    actionText = level;
                }

                if(isNaN(lat) || isNaN(lng)) return;

                // 顏色與旗標 (Benchmark Flag)
                let colorClass = 'bg-mid';
                let colorHex = '#3b82f6';
                let isBenchmark = false;

                if (level.includes('標竿') || e >= 0.999) { 
                    colorClass = 'bg-benchmark'; 
                    colorHex = '#facc15'; 
                    isBenchmark = true; // 標記為標竿
                }
                else if (level.includes('高') || (e >= 0.8 && e < 0.999)) { colorClass = 'bg-high'; colorHex = '#22c55e'; }
                else if (level.includes('中') || (e >= 0.5 && e < 0.8)) { colorClass = 'bg-mid'; colorHex = '#3b82f6'; }
                else if (level.includes('低') || e < 0.5) { colorClass = 'bg-low'; colorHex = '#ef4444'; }

                // 決定圖標 (核心修改邏輯)
                let iconClass = 'fa-bicycle';
                
                if (isBenchmark) {
                    // ★ 標竿站點強制使用打勾圖示 ★
                    iconClass = 'fa-check';
                } else {
                    // 非標竿站點才依據模式變換圖示
                    if (currentMode === 'dispatch') {
                        if (netFlow > 0) iconClass = 'fa-arrow-up';
                        else if (netFlow < 0) iconClass = 'fa-arrow-down';
                        else iconClass = 'fa-balance-scale';
                    } else if (currentMode === 'efficiency') {
                        iconClass = 'fa-chart-bar';
                    } else {
                        if (actionText.includes('縮減')) iconClass = 'fa-compress-alt';
                        else if (actionText.includes('維持')) iconClass = 'fa-check'; // 這裡可能與標竿重疊，但標竿已在前一個if處理
                        else if (actionText.includes('觀察')) iconClass = 'fa-eye';
                    }
                }

                // Marker
                // 標竿站點字體顏色用深色 (#333)，其他用白色 (#fff)
                const iconHtml = `
                    <div style="background-color: ${colorHex}" class="marker-pin"></div>
                    <i class="fas ${iconClass} marker-icon" style="color: ${colorHex === '#facc15' ? '#333' : '#fff'}"></i>
                `;
                const marker = L.marker([lat, lng], {
                    icon: L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [36, 42], iconAnchor: [18, 42], popupAnchor: [0, -40] })
                });

                // Popup
                const popupContent = `
                    <div class="p-1 min-w-[200px]">
                        <h3 class="font-bold text-slate-800 border-b pb-1 mb-2">${name}</h3>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between"><span class="text-gray-500">效率值:</span> <b>${e.toFixed(3)}</b></div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">建議減少:</span> 
                                <span class="${slackDocks > 5 ? 'text-red-500 font-bold' : ''}">${slackDocks > 0 ? slackDocks.toFixed(1) + ' 輛' : '-'}</span>
                            </div>
                            <div class="flex justify-between"><span class="text-gray-500">淨流量:</span> <span class="${netFlow>0?'text-red-500':'text-green-500'} font-bold">${netFlow>0?'+'+netFlow:netFlow}</span></div>
                            <div class="mt-2 bg-slate-50 p-2 rounded text-xs border border-slate-100">
                                <span class="font-bold text-slate-600 block mb-1">資訊:</span>
                                ${actionText}
                            </div>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                marker.addTo(map);
                markers.push(marker);

                // Table Row
                const tr = document.createElement('tr');
                tr.className = 'station-row';
                tr.innerHTML = `
                    <td class="px-4 py-3 text-center"><span class="inline-block w-3 h-3 rounded-full ${colorClass} shadow-sm border border-black/10" title="${level}"></span></td>
                    <td class="px-4 py-3 font-bold text-slate-700">${name}</td>
                    <td class="px-4 py-3 text-center text-slate-500 font-mono">${e.toFixed(3)}</td>
                    <td class="px-4 py-3 text-center font-bold ${slackDocks > 5 ? 'text-red-500' : ''}">
                        ${slackDocks > 0 ? slackDocks.toFixed(1) : '-'}
                    </td>
                    <td class="px-4 py-3 text-center font-bold ${netFlow > 0 ? 'text-red-500' : (netFlow < 0 ? 'text-green-500' : 'text-gray-400')}">
                        ${netFlow > 0 ? '+' + netFlow : netFlow}
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-600 font-medium">${actionText}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="zoomTo(${lat}, ${lng}, '${name}')" class="text-blue-600 hover:text-white hover:bg-blue-600 border border-blue-200 px-2 py-1 rounded transition text-xs">
                            定位
                        </button>
                    </td>
                `;
                tr.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    zoomTo(lat, lng, name);
                    document.querySelectorAll('.station-row').forEach(r => r.classList.remove('active'));
                    tr.classList.add('active');
                };
                tbody.appendChild(tr);
            });
        }

        window.zoomTo = function(lat, lng, name) {
            map.flyTo([lat, lng], 16, { duration: 1.2 });
            setTimeout(() => {
                markers.forEach(m => {
                    const mLat = m.getLatLng().lat;
                    const mLng = m.getLatLng().lng;
                    if (Math.abs(mLat - lat) < 0.0001 && Math.abs(mLng - lng) < 0.0001) {
                        m.openPopup();
                    }
                });
            }, 1200);
        }

        function loadDemoData() {
            const raw = `DMU\tLatitude\tLongitude\tDEA_E_Score\tSlack_Docks\tSlack_Pop\tY1_Borrow\tY2_Return\tNetFlow\t效率等級\t資源分配與規模調整\t營運調度
捷運公館站(2號出口)\t25.01491\t121.53438\t1\t0\t0\t49085\t52170\t-3085\t標竿站點（E≈1.0）\t【維持現狀】：資源配置合理\t【加強清運】：嚴重淨吸納
捷運六張犁站\t25.02397\t121.55266\t0.616\t24.6\t3471.1\t21127\t19985\t1142\t中效率站點\t【縮減規模】：拆除部分車柱\t【頻繁補給】：嚴重淨輸出
捷運麟光站(2號出口)\t25.0181\t121.55929\t0.3789\t31.1\t5615.2\t4380\t4569\t-189\t低效率站點\t【列入觀察】：效率待提升\t【流量平衡】：持續觀察
捷運忠孝新生站(4號出口)\t25.04239\t121.53324\t0.508\t22.6\t7305.6\t13697\t12973\t724\t中效率站點\t【縮減規模】：拆除部分車柱\t【頻繁補給】：嚴重淨輸出`;
            
            const data = parseCSV(raw);
            allData = data;
            updateCounts();
            renderView();
        }
    </script>
</body>
</html>
